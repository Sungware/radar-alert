<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Radar Yakınlık Uyarısı</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
      body, html {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }

      #map {
        height: 90vh;
        width: 100%;
        display: none;
      }

      #alert {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #f44336;
        color: white;
        padding: 10px 20px;
        font-weight: bold;
        display: none;
        border-radius: 5px;
        z-index: 1000;
      }

      #start-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-size: 24px;
        background-color: #2196f3;
        color: white;
        border: none;
        width: 100%;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="start-btn">Uygulamayı Başlat</button>
    <div id="alert"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      const markers = [
        {
          Aciklama: "Radar 1",
          lat: 41.16418,
          lng: 28.189972,
        },
        {
          Aciklama: "Radar 2",
          lat: 41.00399,
          lng: 28.982493,
        },
        {
          Aciklama: "Radar 3",
          lat: 40.96419,
          lng: 28.817257,
        },
      ];

      const alertSound = new Audio("https://sungware.github.io/radar-alert/beep.mp3");
alertSound.volume = 0.5;

      let lastAlertTime = 0;
      const alertCooldown = 15000;

      function startApp() {
        document.getElementById("start-btn").style.display = "none";
        document.getElementById("map").style.display = "block";

        // Ses izni tetiklemek için ilk etkileşimde sesi başlat
        alertSound.play().then(() => {
          console.log("Ses izni verildi.");
        }).catch(() => {
          console.warn("Ses izni verilmedi.");
        });

        const map = L.map("map").setView([41.0, 28.8], 11);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        }).addTo(map);

        markers.forEach((data) => {
          L.marker([data.lat, data.lng]).addTo(map).bindPopup(data.Aciklama);
        });

        function showAlert(msg) {
          const alertDiv = document.getElementById("alert");
          alertDiv.innerText = msg;
          alertDiv.style.display = "block";
        }

        function hideAlert() {
          const alertDiv = document.getElementById("alert");
          alertDiv.style.display = "none";
        }

        function onLocationFound(e) {
          const userLatLng = e.latlng;
          L.marker(userLatLng, { title: "Senin Konumun" })
            .addTo(map)
            .bindPopup("Buradasın")
            .openPopup();

          let alertShown = false;
          markers.forEach((radar) => {
            const radarLatLng = L.latLng(radar.lat, radar.lng);
            const distance = userLatLng.distanceTo(radarLatLng);
            if (distance <= 50000) {
              showAlert(
                `Dikkat! ${radar.Aciklama} radarına ${Math.round(
                  distance
                )} metre yaklaştınız.`
              );
              alertShown = true;

              const now = Date.now();
              if (now - lastAlertTime > alertCooldown) {
                alertSound.play().catch(() => {});
                lastAlertTime = now;
              }
            }
          });

          if (!alertShown) hideAlert();
        }

        function onLocationError(e) {
          alert("Konum bilgisi alınamadı. Lütfen konum izinlerini kontrol edin.");
        }

        map.locate({ setView: true, maxZoom: 16, watch: true });
        map.on("locationfound", onLocationFound);
        map.on("locationerror", onLocationError);
      }

      document.getElementById("start-btn").addEventListener("click", startApp);
    </script>
  </body>
</html>
